extends ../../layouts/default
include ../../mixins/search.pug

block head
  link(rel="stylesheet", href="/public/admin/css/lesson-content.css")

block main
  .lesson-content-page
    //- Page Header
    .page-header
      .header-content
        .header-left
          h3.page-title= pageTitle || 'Nội dung khóa học'
          .summary-stats
            span.stat-item
              i.bi.bi-collection
              span= totalSections + ' chương'
            span.stat-item
              i.bi.bi-play-circle
              span= totalLessons + ' bài học'
        
        .header-actions
          if filterSection
            a.btn.btn-outline-secondary(href=`${prefixAdmin}/courses/${courseId}/lessons`)
              i.bi.bi-x-circle
              span Xóa lọc
          
          button.btn.btn-primary(
            data-bs-toggle="collapse"
            href="#createSectionForm"
            role="button"
            aria-expanded="false"
            aria-controls="createSectionForm"
          )
            i.bi.bi-plus-circle
            span Thêm chương

    //- Quick Create Section Form
    .collapse#createSectionForm
      .create-section-card
        .card-header
          h5.card-title
            i.bi.bi-plus-circle
            span Tạo chương mới
        .card-body
          form.create-form(action=`${prefixAdmin}/courses/${courseId}/sections`, method="post")
            input(type='hidden', name='course', value=String(courseId))
            .form-row
              .form-group
                label.form-label(for="sec-title") Tiêu đề chương
                input#sec-title.form-control(type="text" name="title" required placeholder="VD: Giới thiệu")
              .form-group.flex-grow
                label.form-label(for="sec-summary") Mô tả ngắn
                input#sec-summary.form-control(type="text" name="summary" placeholder="Mô tả ngắn gọn về chương này")
              .form-group
                button.btn.btn-primary(type="submit")
                  i.bi.bi-check
                  span Tạo chương

    //- Main Content
    .content-area
      if !sections || sections.length === 0
        .empty-state
          .empty-icon
            i.bi.bi-journal-x
          .empty-content
            h4 Chưa có chương nào
            p Hãy tạo chương đầu tiên để bắt đầu xây dựng khóa học của bạn
      else
        //- Sections Accordion
        - var openId = String(filterSection || '')
        .sections-container
          .accordion#sectionsAccordion
            each s, si in sections
              - var sid = `sec-${s._id}`
              - var eid = `edit-sec-${s._id}`
              - var isOpen = (String(s._id) === openId) || (!openId && si === 0)

              .section-item.accordion-item
                .section-header.accordion-header
                  .section-main
                    button.section-toggle.accordion-button(
                      class=isOpen ? '' : 'collapsed',
                      type="button",
                      data-bs-toggle="collapse",
                      data-bs-target=`#${sid}`,
                      aria-expanded=isOpen ? 'true' : 'false',
                      aria-controls=sid
                    )
                      .section-info
                        .section-badge #{s.sortOrder || si + 1}
                        .section-details
                          .section-title= s.title || s.name || `Section ${s.sortOrder || ''}`
                          if s.summary
                            .section-summary= s.summary
                      .section-stats
                        .lesson-count
                          i.bi.bi-play-circle
                          span #{(s.lessons && s.lessons.length) ? s.lessons.length : 0}

                  .section-actions
                    .action-group
                      form(action=`${prefixAdmin}/courses/${courseId}/sections/${s._id}/move?_method=PATCH` method="post")
                        input(type="hidden" name="dir" value="up")
                        button.btn-action.btn-move(type="submit" title="Chuyển lên")
                          i.bi.bi-arrow-up
                      
                      form(action=`${prefixAdmin}/courses/${courseId}/sections/${s._id}/move?_method=PATCH` method="post")
                        input(type="hidden" name="dir" value="down")
                        button.btn-action.btn-move(type="submit" title="Chuyển xuống")
                          i.bi.bi-arrow-down
                      
                      button.btn-action.btn-edit(
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target=`#${eid}`
                        aria-expanded="false"
                        aria-controls=eid
                        title="Sửa chương"
                      )
                        i.bi.bi-pencil-square
                      
                      form(action=`${prefixAdmin}/courses/${courseId}/sections/${s._id}?_method=DELETE` method="post" onsubmit="return confirm('Xóa chương này và toàn bộ bài học thuộc chương?');")
                        button.btn-action.btn-delete(type="submit" title="Xóa chương")
                          i.bi.bi-trash

                //- Edit Section Form
                .section-edit.collapse(id='edit-sec-' + String(s._id))
                  .edit-form-container
                    form.edit-form(action=`${prefixAdmin}/courses/${courseId}/sections/${s._id}?_method=PUT` method="post")
                      input(type='hidden', name='course', value=String(courseId))
                      .form-row
                        .form-group
                          label.form-label(for=`title-${s._id}`) Tiêu đề
                          input.form-control(type="text" id=`title-${s._id}` name="title" required value=s.title)
                        .form-group.flex-grow
                          label.form-label(for=`summary-${s._id}`) Mô tả ngắn
                          input.form-control(type="text" id=`summary-${s._id}` name="summary" value=s.summary)
                        .form-group
                          button.btn.btn-success(type="submit")
                            i.bi.bi-check
                            span Cập nhật

                //- Section Content
                .section-content.accordion-collapse.collapse(id=sid class=isOpen ? 'show' : '' data-bs-parent="#sectionsAccordion")
                  .section-body
                    if !s.lessons || s.lessons.length === 0
                      .no-lessons
                        .no-lessons-content
                          i.bi.bi-play-circle
                          span Chưa có bài học trong chương này
                    else
                      .lessons-table
                        .table-responsive
                          table.table.lessons-list
                            thead
                              tr
                                th.col-order #
                                th.col-title Tiêu đề bài học
                                th.col-type Loại
                                th.col-duration Thời lượng
                                th.col-preview Xem trước
                                th.col-resources Tài nguyên
                                th.col-actions Hành động
                            tbody
                              each l, idx in s.lessons
                                tr.lesson-row
                                  td.lesson-order= l.sortOrder || (idx + 1)
                                  td.lesson-title
                                    .lesson-name= l.title
                                  td.lesson-type
                                    .type-badge(class=`type-${l.type ? l.type.toLowerCase() : 'default'}`)= l.type
                                  td.lesson-duration= l.durationSec ? Math.round(l.durationSec / 60) + ' phút' : '—'
                                  td.lesson-preview
                                    if l.isFreePreview
                                      .preview-badge.preview-free Miễn phí
                                    else
                                      .preview-badge.preview-paid Có phí
                                  td.lesson-resources
                                    if l.resources && l.resources.length
                                      .resource-list
                                        each r, ri in l.resources
                                          .resource-item
                                            .resource-type= r.kind || 'File'
                                            a.resource-link(href=r.viewUrl || r.url target="_blank" rel="noopener")
                                              = r.title || `Tệp ${ri+1}`
                                    else
                                      span.no-resources —
                                  td.lesson-actions
                                    .action-buttons
                                      a.action-btn.btn-edit(
                                        href=`${prefixAdmin}/courses/${courseId}/lessons/${l._id}/edit`, 
                                        title="Chỉnh sửa bài học"
                                      )
                                        i.bi.bi-pencil-square
                                        span Sửa
                                      
                                      .action-dropdown
                                        button.action-btn.btn-more(type="button" data-bs-toggle="dropdown")
                                          i.bi.bi-three-dots
                                        
                                        .dropdown-menu.dropdown-menu-end
                                          form(action=`${prefixAdmin}/courses/${courseId}/lessons/${l._id}/move?_method=PATCH` method="post")
                                            input(type="hidden" name="dir" value="up")
                                            button.dropdown-item(type="submit")
                                              i.bi.bi-arrow-up
                                              span Chuyển lên
                                          
                                          form(action=`${prefixAdmin}/courses/${courseId}/lessons/${l._id}/move?_method=PATCH` method="post")
                                            input(type="hidden" name="dir" value="down")
                                            button.dropdown-item(type="submit")
                                              i.bi.bi-arrow-down
                                              span Chuyển xuống
                                          
                                          .dropdown-divider
                                          
                                          form(action=`${prefixAdmin}/courses/${courseId}/lessons/${l._id}?_method=DELETE` method="post" onsubmit="return confirm('Xóa bài học này?');")
                                            button.dropdown-item.text-danger(type="submit")
                                              i.bi.bi-trash
                                              span Xóa bài học

                  .section-footer
                    a.btn.btn-outline-primary.add-lesson-btn(href=`${prefixAdmin}/courses/${courseId}/lessons/create?section=${s._id}`)
                      i.bi.bi-plus-circle
                      span Thêm bài học

block scripts
  script.
    (function(){
      const url = new URL(window.location.href);
      const sec = url.searchParams.get('section');
      if(!sec) return;
      const pane = document.getElementById('sec-' + sec);
      if(pane && !pane.classList.contains('show')) {
        pane.classList.add('show');
        const btn = document.querySelector(`[data-bs-target="#sec-${sec}"]`);
        if(btn) btn.classList.remove('collapsed');
      }
    })();